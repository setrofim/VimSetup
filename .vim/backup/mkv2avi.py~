#!/usr/bin/python
import os, sys
import shlex
from subprocess import Popen, PIPE, STDOUT


CMD_TEMPLATE =  r'ffmpeg -i "%s" -vcodec mpeg4 -b 4800000 -acodec copy -ar 128000 -ac 2 "%s"'

def usage():
    print "Mastroka repacker script"
    print "  Usage: python " + os.path.basename(__file__) + " <sourcedir> <destdir>"

if __name__ == "__main__":
    if len(sys.argv) < 3:
       usage()
    else:
       sourcedir = sys.argv[1]
       destdir = sys.argv[2]

       if not os.path.isdir(destdir):
           os.makedirs(destdir)

       with open('mkv2avi_convert.log', 'w') as log:
           for filename in os.listdir(sourcedir):
               if not filename.lower().endswith('.mkv'):
                   continue
               print 'processing', filename
               filepath = os.path.join(sourcedir, filename)
               outfile = os.path.join(destdir, os.path.splitext(filename)[0] + '.avi')

               if os.path.isfile(outfile):
                   print 'error:', outfile, 'already exists'
                   continue

               command = CMD_TEMPLATE % (os.path.abspath(filepath), os.path.abspath(outfile))
               #print command
               os.system(command)
               #command = shlex.split(CMD_TEMPLATE % (filepath, outfile))
               #print 'COMMAND:', command
               #c = Popen(command, stdout=PIPE, stderr=STDOUT, shell=False)
               #log.write(c.communicate()[0] + ('=' * 80) + '\n')

